<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A repository for my thoughts"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>It's legos all the way down</title></head><body><header id=banner><h2><a href=https://www.hailelagi.com/>Haile (ሐይሌ)</a></h2><nav><ul><li><a href=/bookshelf title=bookshelf>bookshelf</a></li><li><a href=https://www.github.com/hailelagi title=github>github</a></li><li><a href=/notes title=notes>notes</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>It's legos all the way down</h1><time>February 17, 2023</time></header><h3 id=introduction>Introduction</h3><p>Often as folks who create useful software things we tend to think of ourselves as people who write software for the mythical &ldquo;user&rdquo;. A &ldquo;user&rdquo; clicks a button and
something magical happens. This is commonly reffered to as an <a href=https://en.wikipedia.org/wiki/Abstraction_(computer_science)>abstraction</a>.
Abstractions are all around us in software and clever programmers create good abstractions for other programmers often to manage complexity.</p><p>A really common example of this is an <a href=https://en.wikipedia.org/wiki/API>Application Programming Interface</a> which allows two &ldquo;applications&rdquo; to share useful data with each other over some transport while being platform-agnostic as to how this data is used. Like an API, there are other interesting kinds of abstractions &ndash; let&rsquo;s peel back the abstraction between the language creator and language user by <em>inventing syntax!</em></p><p>This involves a subtle shift in the paradigm used to understand computation, at the <em>core</em> is the idea of viewing <strong>computation as data</strong>. I would guess for most people,
the typical mental model when reading at first is mostly <em>procedural</em>, a top-down scan with familiarity of syntax and semantics, then another important shift occurs in
understanding runtime execution with the introduction of concurrency and parallelism, here we&rsquo;ll be peeling back at the layer between <em>compile time</em> and <em>runtime</em>.</p><p>Compile time occurs when program text is being &ldquo;parsed and transformed&rdquo; into many forms all the way to bits and runtime
is when the program is actually executing ie &ldquo;running&rdquo;, in this paradigm of viewing programs as textual input to other programs and to the program itself while running, is known as metaprogramming.</p><pre tabindex=0><code> This distinction between what is &#34;compile&#34; and &#34;runtime&#34; is
 a useful mental model illustrated here for simplicity, odds
 are what&#39;s happening in your favorite language is probably 
 more interesting![11]
</code></pre><p>Before we begin, a caveat. Although this technique applies broadly to most modern languages &ndash; implementations vary in feature parity, I&rsquo;ll try to primarily include alternate examples with go&rsquo;s <a href=https://go.dev/blog/laws-of-reflection>reflection</a> and rust&rsquo;s <a href=https://doc.rust-lang.org/book/ch19-06-macros.html>macro system</a> while providing nods to Cpython<a href=#references>[1]</a>, Ruby MRI<a href=#references>[2]</a> and some javascript <a href=#references>[3]</a> but not typescript<a href=#references>[4]</a></p><h3 id=computation-is-data>Computation is data</h3><p>Consider for example the humble <code>eval()</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// javascript
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=s1>&#39;2 + 2&#39;</span><span class=p>));</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=c1># python</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=s1>&#39;2 + 2&#39;</span><span class=p>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># ruby</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=nb>eval</span><span class=p>(</span><span class=s1>&#39;2 + 2&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>The computation <code>2 + 2</code> is represented as data, in this case a <code>string</code>. That&rsquo;s kind of neat isn&rsquo;t it? however we can take this much futher.
If you&rsquo;re interested in further details of what&rsquo;s happening here, checkout <a href=https://craftinginterpreters.com/>crafting interpreters</a>.</p><p>Since programming languages contain all sorts of elements like <em>expressions</em> and <em>statements</em>, we need some
way to hold information about what the program or computation is trying to do, this internal representation is most commonly known as an Abstract Syntax Tree.</p><p>At the risk of oversimplification, think of an AST as a way to meaningfully represent the textual source of a program that sometimes allows you to do something resembling <a href=https://en.wikipedia.org/wiki/String_interpolation>string interpolation</a> operations on your program&rsquo;s text source.</p><h3 id=prelude-why-meta>Prelude, why meta?</h3><p>To illustrate this concept, lets see how one might add syntax to create a <a href=https://en.wikipedia.org/wiki/Constructor_(object-oriented_programming)>constructor</a> for a <a href=https://en.wikipedia.org/wiki/Dynamic_array>dynamic array</a> in <code>elixir</code>.</p><p>First, some background. Elixir is a (mostly) functional language with (mostly) immutable datastructures, it doesn&rsquo;t encourage the use of
or provide a dynamic array out of the box like most functional languages, as the implementation of one
requires random access read/write via mutable state. Nor does it have &ldquo;constructors&rdquo;, a typical pattern is creating structured data returned from
a function and <a href=https://elixirschool.com/en/lessons/basics/pipe_operator>&ldquo;piping&rdquo;</a> it through several other functions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>MyApp.Array</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>MyApp.Array</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>defstruct</span> <span class=ss>field</span><span class=p>:</span> <span class=no>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>new</span><span class=p>(</span><span class=n>options</span> <span class=p>\\</span> <span class=p>[])</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>%</span><span class=nc>Array</span><span class=p>{</span><span class=ss>field</span><span class=p>:</span> <span class=n>options</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>iex</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nc>MyApp.Array</span><span class=o>.</span><span class=n>new</span><span class=p>()</span> <span class=o>|&gt;</span> <span class=n>do_stuff</span><span class=p>()</span> <span class=o>|&gt;</span> <span class=n>do_other_stuff</span><span class=p>()</span>
</span></span></code></pre></div><p>For this example, we&rsquo;re going to piggyback off the rust standard library&rsquo;s <a href=https://doc.rust-lang.org/std/vec/struct.Vec.html>Vector</a> by
creating a <a href=https://en.wikipedia.org/wiki/Foreign_function_interface>foreign function interface</a> in elixir and alternatively a data structure implemented in the <a href=https://www.erlang.org/doc/man/array.html>erlang stdlib</a> in order to re-create something like <code>vec!</code></p><p>As we&rsquo;ll see the &ldquo;backend&rdquo; implementation of the data structure is not important, the fact that it&rsquo;s in rust or erlang doesn&rsquo;t matter, what we&rsquo;re focused on is providing an easy to use syntactic abstraction
of a common datastructure.</p><p>Here&rsquo;s a simplified version pulled straight from <a href=https://doc.rust-lang.org/book/ch19-06-macros.html>the rust book</a> of <code>vec!</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[macro_export]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>macro_rules</span><span class=o>!</span><span class=w> </span><span class=n>vec</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=w> </span><span class=cp>$(</span><span class=w> </span><span class=cp>$x</span>:<span class=nc>expr</span><span class=w> </span><span class=p>),</span><span class=o>*</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>temp_vec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=cp>$(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>temp_vec</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=cp>$x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>temp_vec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Here we see a pattern match <code>( $( $x:expr ),* )</code> like our humble <code>eval('2 + 2')</code> instead of representing the computation as a string, it&rsquo;s a tree like data-structure
where we can assert at compile time, if some code looks like what we think it looks like, replace it with what&rsquo;s in the match arm,
a process known as <code>macro expansion</code>.</p><p>In elixir, we can write something similar, the pattern match is a three-element style tuple<a href=#references>[5]</a>:</p><p><code>{node, execution_context or meta_data, arguments}</code></p><p>Go and ruby share some superficial similarities as their metaprogramming api doesn&rsquo;t give you direct access to the AST. In ruby libraries like <code>RSpec</code>,<code>rails</code> router and <code>erb</code> html templates often use metaprogramming techniques via &ldquo;monkey patching&rdquo; &ndash; modifying at <em>runtime</em> various
properties of an object<a href=#references>[6]</a> and since in ruby&rsquo;s <em>extremely dynamically typed</em><a href=#references>[7]</a> interpreted world there is no notion of &ldquo;compile time expansion&rdquo; instead you have powerful introspection and malleability at runtime giving rise to patterns like <code>hooks</code><a href=#references>[8]</a> to alter nearly almost anything about the language via object properties, syntax or not.</p><p>Take this small excerpt<a href=#references>[9]</a> from <a href=https://github.com/rspec/rspec-core>rspec-core</a> of the <code>describe</code> public api:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># @private</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>expose_example_group_alias</span><span class=p>(</span><span class=nb>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>if</span> <span class=n>example_group_aliases</span><span class=o>.</span><span class=n>include?</span><span class=p>(</span><span class=nb>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>example_group_aliases</span> <span class=o>&lt;&lt;</span> <span class=nb>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=k>class</span> <span class=o>&lt;&lt;</span> <span class=no>RSpec</span><span class=p>;</span> <span class=nb>self</span><span class=p>;</span> <span class=k>end</span><span class=p>)</span><span class=o>.</span><span class=n>__send__</span><span class=p>(</span><span class=ss>:define_method</span><span class=p>,</span> <span class=nb>name</span><span class=p>)</span> <span class=k>do</span> <span class=o>|*</span><span class=n>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>example_group_block</span><span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=no>RSpec</span><span class=o>::</span><span class=no>Core</span><span class=o>::</span><span class=no>ExampleGroup</span><span class=o>.</span><span class=n>__send__</span><span class=p>(</span><span class=nb>name</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>example_group_block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=no>RSpec</span><span class=o>.</span><span class=n>world</span><span class=o>.</span><span class=n>record</span><span class=p>(</span><span class=n>group</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>expose_example_group_alias_globally</span><span class=p>(</span><span class=nb>name</span><span class=p>)</span> <span class=k>if</span> <span class=n>exposed_globally?</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>There&rsquo;s alot happening but the important thing to note is <code>RSpec::Core::ExampleGroup</code> is an object that is being modified at the test-runner&rsquo;s runtime which specifies the linguistic structure of the <em>domain&rsquo;s specific language</em> of what <code>describe</code> means.</p><p>In go like ruby we have <code>reflection</code> that allows runtime introspection, unlike ruby it is statically typed and compiled. Reflection gives a temporary &ldquo;escape hatch&rdquo; out of the rigid type system and allows modification based on dynamic <code>interfaces</code> the most idiomatic example of this I can find are the printing family<a href=#references>[10]</a> functions like <code>fmt.Sprintf</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>pp</span><span class=p>)</span> <span class=nf>doPrint</span><span class=p>(</span><span class=nx>a</span> <span class=p>[]</span><span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>prevString</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl> <span class=k>for</span> <span class=nx>argNum</span><span class=p>,</span> <span class=nx>arg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>a</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>isString</span> <span class=o>:=</span> <span class=nx>arg</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>arg</span><span class=p>).</span><span class=nf>Kind</span><span class=p>()</span> <span class=o>==</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>String</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Add a space between two non-string arguments.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=nx>argNum</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>isString</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>prevString</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>p</span><span class=p>.</span><span class=nx>buf</span><span class=p>.</span><span class=nf>writeByte</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>p</span><span class=p>.</span><span class=nf>printArg</span><span class=p>(</span><span class=nx>arg</span><span class=p>,</span> <span class=sc>&#39;v&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>prevString</span> <span class=p>=</span> <span class=nx>isString</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=building-a-dynamic-array-constructor-in-elixir>Building a (Dynamic) Array &ldquo;constructor&rdquo; in Elixir</h3><p>Now, let&rsquo;s get hands on. Everything here lives in a mix project called <a href=https://github.com/hailelagi/ex_vec><code>ExVec</code></a> and defining the macro&rsquo;s public api:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>ExVec</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>ExVec</span><span class=o>.</span><span class=p>{</span><span class=nc>Array</span><span class=p>,</span> <span class=nc>Vector</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>defmacro</span> <span class=n>__using__</span><span class=p>(</span><span class=ss>implementation</span><span class=p>:</span> <span class=n>impl</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>quote</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=kn>import</span> <span class=k>unquote</span><span class=p>(</span><span class=n>__MODULE__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nc>Module</span><span class=o>.</span><span class=n>put_attribute</span><span class=p>(</span><span class=n>__MODULE__</span><span class=p>,</span> <span class=ss>:implementation</span><span class=p>,</span> <span class=k>unquote</span><span class=p>(</span><span class=n>impl</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>defmacro</span> <span class=n>vec!</span><span class=p>([</span><span class=n>_h</span> <span class=o>|</span> <span class=n>_t</span><span class=p>]</span> <span class=o>=</span> <span class=n>args</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>quote</span> <span class=ss>bind_quoted</span><span class=p>:</span> <span class=p>[</span><span class=ss>args</span><span class=p>:</span> <span class=n>args</span><span class=p>]</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=n>dispatch_constructor</span><span class=p>(</span><span class=na>@implementation</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>defmacro</span> <span class=n>vec!</span><span class=p>({</span><span class=ss>:.</span><span class=o>.</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=p>[</span><span class=n>first</span><span class=p>,</span> <span class=n>last</span><span class=p>]})</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=nc>Range</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>first</span><span class=p>,</span> <span class=n>last</span><span class=p>)</span> <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>to_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>quote</span> <span class=ss>bind_quoted</span><span class=p>:</span> <span class=p>[</span><span class=ss>args</span><span class=p>:</span> <span class=n>args</span><span class=p>]</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=n>dispatch_constructor</span><span class=p>(</span><span class=na>@implementation</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>dispatch_constructor</span><span class=p>(</span><span class=n>impl</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=n>impl</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=ss>:rust</span> <span class=o>-&gt;</span> <span class=nc>Vector</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=ss>:erlang</span> <span class=o>-&gt;</span> <span class=nc>Array</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>_</span> <span class=o>-&gt;</span> <span class=k>raise</span> <span class=s2>&#34;invalid constructor type, did you mean :rust?&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>The <code>ex_vec</code> library has two backends <code>ExVec.Array</code> which is a thin wrapper around <a href=https://www.erlang.org/doc/man/array.html><code>:array</code></a> and <code>ExVec.Vector</code> which is a NIF wrapper that leverages rustler&rsquo;s <code>Encoder</code> and <code>Decoder</code> to encode an elixir <code>List</code> as a <code>Vec</code> then implementing interfaces for what an array might look like in elixir by defining:</p><ol><li>The <code>Access</code> behaviour</li><li>A protocol implementation of <code>Enumerable</code></li></ol><p>By implementing these specifications we can safely use things from stdlib like <code>Enum</code> and even <code>Stream</code> and just like that in any other elixir project
and letting the client choose the backend while keep the macro&rsquo;s syntax:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>MyApp.DoStuff</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>alias</span> <span class=nc>ExVec.Vector</span>
</span></span><span class=line><span class=cl>  <span class=kn>use</span> <span class=nc>ExVec</span><span class=p>,</span> <span class=ss>implementation</span><span class=p>:</span> <span class=ss>:rust</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>len</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=c1># serialised as a rust Vec&lt;i32&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>vec!</span><span class=p>(</span><span class=mi>1</span><span class=o>..</span><span class=mi>4</span><span class=p>)</span> <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>vec!</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span> <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># plain old linked-list</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>random_access</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=c1># O(1) read</span>
</span></span><span class=line><span class=cl>    <span class=n>my_array</span> <span class=o>=</span> <span class=n>vec!</span><span class=p>(</span><span class=mi>0</span><span class=o>..</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>my_array</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=c1># serialised random write access</span>
</span></span><span class=line><span class=cl>    <span class=nc>Vector</span><span class=o>.</span><span class=n>get_and_update</span><span class=p>(</span><span class=n>my_array</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>fn</span> <span class=n>n</span> <span class=o>-&gt;</span> <span class=p>{</span><span class=n>n</span><span class=p>,</span> <span class=mi>42</span><span class=p>}</span> <span class=k>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>MyApp.DoOtherStuff</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kn>use</span> <span class=nc>ExVec</span><span class=p>,</span> <span class=ss>implementation</span><span class=p>:</span> <span class=ss>:erlang</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>def</span> <span class=n>len</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=c1># this is an erlang :array!</span>
</span></span><span class=line><span class=cl>    <span class=n>vec!</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span> <span class=o>|&gt;</span> <span class=nc>Enum</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>unfortunately as of the time of this writing, <code>rustler</code> <a href=https://github.com/rusterlium/rustler/issues/424>does not support</a> generic type intefaces so I
guess this is impossible?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug, NifStruct)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[module = </span><span class=s>&#34;ExVec.Vector&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Vector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>fields</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>size</span>: <span class=kt>isize</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Therefore a serious limitation of this toy example is it only works for <code>i32</code> integers :) I also glossed over some behaviours and protocols with defaults.</p><p>You can find the full source for this example <a href=https://github.com/hailelagi/ex_vec>here</a>, please let me know if you have a comment, found a bug or typo. Thanks for reading!</p><h2 id=references>References</h2><p>[1] Python3&rsquo;s excellent <code>ast</code> library: <a href=https://docs.python.org/3/library/ast.html>https://docs.python.org/3/library/ast.html</a></p><p>[2] RubyVM::AST : <a href=https://ruby-doc.org/core-trunk/RubyVM/AST.html>https://ruby-doc.org/core-trunk/RubyVM/AST.html</a></p><p>[3] Javascript(since ECMAScript6): <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect</a></p><p>[4] Typescript: <a href=https://basarat.gitbook.io/typescript/overview>https://basarat.gitbook.io/typescript/overview</a></p><p>[4] Go&rsquo;s AST : <a href=https://pkg.go.dev/go/ast>https://pkg.go.dev/go/ast</a></p><p>[5] Elixir&rsquo;s AST: <a href=https://github.com/elixir-lang/elixir/blob/d8f1a5d6b653c14ae44c6eacdbc8e9df7006d284/lib/elixir/pages/syntax-reference.md#the-elixir-ast>https://github.com/elixir-lang/elixir/blob/d8f1a5d6b653c14ae44c6eacdbc8e9df7006d284/lib/elixir/pages/syntax-reference.md#the-elixir-ast</a></p><p>[6] The one true (<em>useful</em>) object to rule them all: <a href=https://ruby-doc.org/3.2.1/Object.html>https://ruby-doc.org/3.2.1/Object.html</a></p><p>[7] Ruby Extensions: <a href=https://docs.ruby-lang.org/en/master/extension_rdoc.html#label-Basic+Knowledge>https://docs.ruby-lang.org/en/master/extension_rdoc.html#label-Basic+Knowledge</a></p><p>[8] Awesome example of the <code>hook pattern</code> into ruby&rsquo;s object lifecyle: <a href=https://github.com/rspec/rspec-core/blob/main/lib/rspec/core/hooks.rb>https://github.com/rspec/rspec-core/blob/main/lib/rspec/core/hooks.rb</a></p><p>[9] RSpec public DSL module: <a href=https://github.com/rspec/rspec-core/blob/main/lib/rspec/core/dsl.rb>https://github.com/rspec/rspec-core/blob/main/lib/rspec/core/dsl.rb</a></p><p>[10] doPrint: <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.20:src/fmt/print.go;drc=261fe25c83a94fc3defe064baed3944cd3d16959;l=1204">https://cs.opensource.google/go/go/+/refs/tags/go1.20:src/fmt/print.go;drc=261fe25c83a94fc3defe064baed3944cd3d16959;l=1204</a></p><p>[11] Just in Time compilation: <a href=https://en.wikipedia.org/wiki/Just-in-time_compilation>https://en.wikipedia.org/wiki/Just-in-time_compilation</a></p></article></main><footer id=footer><a href=https://github.com/hailelagi/blog>source</a>
Copyright © 2024 Haile Lagi<div id=sign-key><span>GPG key ID: 0298F4203ADC85E8</span></div></footer></body></html>