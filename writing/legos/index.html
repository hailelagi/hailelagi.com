<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A repository for my thoughts"><link rel="shortcut icon" href=https://www.hailelagi.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>It's legos all the way down</title></head><body><header id=banner><h2><a href=https://www.hailelagi.com/>Haile (ሐይሌ)</a></h2><nav><ul><li><a href="https://app.zerion.io/0x3430b8b776c531e01736ddfc15b11d9e14afe793/overview?name=haile.eth" title=ethereum>ethereum</a></li><li><a href=https://www.github.com/hailelagi title=github>github</a></li><li><a href=/readme title=readme>readme</a></li><li><a href=/resume title=resume>resume</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>It's legos all the way down</h1><time>January 25, 2023</time></header><p>Often as folks who create useful software things we tend to think of ourselves as people who write software for the mythical &ldquo;user&rdquo;. A &ldquo;user&rdquo; clicks a button and
something magical happens. This is commonly reffered to as an <a href=https://en.wikipedia.org/wiki/Abstraction_(computer_science)>abstraction</a>.
Abstractions are all around us in software and clever programmers create good abstractions for other programmers to save them valuable time and or other resources.</p><p>A really common example of this is an <a href=https://en.wikipedia.org/wiki/API>Application Programming Interface</a> which allows two &ldquo;applications&rdquo; to talk to each other over
some transport. Like an API, there are other interesting kinds of abstractions &ndash; let&rsquo;s talk about the one between the language creator and language user by <em>inventing
syntax in elixir</em>!</p><p>We&rsquo;ll be stepping through how to create a <a href=https://en.wikipedia.org/wiki/Dynamic_array>dynamic array</a> constructor.</p><p>Before we begin, a caveat. Although metaprogramming applies broadly to most modern languages &ndash; implementations vary in feature parity, I&rsquo;ll try to primarily include alternate examples with go&rsquo;s <a href=https://go.dev/blog/laws-of-reflection>reflection</a> and rust&rsquo;s <a href=https://doc.rust-lang.org/book/ch19-06-macros.html>macro system</a> while providing nods to Cpython<a href=#references>[1]</a>, Ruby MRI<a href=#references>[2]</a> and some javascript <a href=#references>[3]</a>) but not typescript<a href=#references>[4]</a></p><h3 id=ast-what>AST what?</h3><p>Abstract Syntax Tree. Okay but what is it? As this is intended to be written in a more hands-on style, at the risk
of oversimplification, think of an AST as a way to meaningfully represent the textual source of a program that sometimes allows you to do something resembling <a href=https://en.wikipedia.org/wiki/String_interpolation>string interpolation</a> operations on your program&rsquo;s text source. Consider for example the humble <code>eval()</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// javascript
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=s1>&#39;2 + 2&#39;</span><span class=p>));</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=c1># python</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=s1>&#39;2 + 2&#39;</span><span class=p>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># ruby</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=nb>eval</span><span class=p>(</span><span class=s1>&#39;2+2&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>That&rsquo;s kind of neat isn&rsquo;t it? But what&rsquo;s going on here? how do we go from a <code>string</code> to a computation?
For the short story continue on! However if you&rsquo;re interested in how compilation works in general checkout <a href=https://craftinginterpreters.com/>crafting interpreters</a>.</p><h3 id=building-a-dynamic-array-constructor-in-elixir>Building a (Dynamic) Array &ldquo;constructor&rdquo; in Elixir</h3><p>First, some background. Elixir is a (mostly) functional language with (mostly) immutable datastructures, it doesn&rsquo;t encourage the use of
or provide a dynamic array out of the box like most functional languages, as the implementation of one
requires random access read/write via internal mutable state.</p><p>If you <em>really</em> need one though, you can reach into the <a href=https://www.erlang.org/doc/man/array.html>erlang stdlib</a>.</p><p>For this we&rsquo;re going to piggyback off the rust standard library&rsquo;s <a href=https://doc.rust-lang.org/std/vec/struct.Vec.html>Vector</a> and
creating a <a href=https://en.wikipedia.org/wiki/Foreign_function_interface>foreign function interface</a> in elixir by re-creating rust&rsquo;s <code>vec!</code> macro api
eventually supporting either the erlang or rust version as a backend.</p><p>As we&rsquo;ll see the &ldquo;backend&rdquo; implementation of the data structure is not important, what we&rsquo;re focused on is providing an easy to use syntactic abstraction
of a common datastructure.</p><p>Here&rsquo;s a simplified version pulled straight from <a href=https://doc.rust-lang.org/book/ch19-06-macros.html>the rust book</a> of <code>vec!</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[macro_export]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>macro_rules!</span><span class=w> </span><span class=n>vec</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=w> </span><span class=cp>$(</span><span class=w> </span><span class=cp>$x</span>:<span class=nc>expr</span><span class=w> </span><span class=p>),</span><span class=o>*</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>temp_vec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=cp>$(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>temp_vec</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=cp>$x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>temp_vec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>In elixir we&rsquo;re going to begin by using a mix project called <a href=https://github.com/hailelagi/ex_vec><code>ExVec</code></a> with a similiar api:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=kd>defmodule</span> <span class=nc>ExVec</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=kd>defmacro</span> <span class=n>vec!</span><span class=p>(</span><span class=n>arguments</span><span class=p>,</span> <span class=ss>do</span><span class=p>:</span> <span class=n>expression</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>quote</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=nc>ExVec.Vector</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h2 id=references>References</h2><p>[1] Python3&rsquo;s excellent <code>ast</code> library: <a href=https://docs.python.org/3/library/ast.html>https://docs.python.org/3/library/ast.html</a></p><p>[2] RubyVM::AST : <a href=https://ruby-doc.org/core-trunk/RubyVM/AST.html>https://ruby-doc.org/core-trunk/RubyVM/AST.html</a></p><p>[3] Javascript(since ECMAScript6): <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect</a></p><p>[4] Typescript: <a href=https://basarat.gitbook.io/typescript/overview>https://basarat.gitbook.io/typescript/overview</a></p><p>[4] Go&rsquo;s AST : <a href=https://pkg.go.dev/go/ast>https://pkg.go.dev/go/ast</a></p><p>[5] Elixir&rsquo;s AST: <a href=https://github.com/elixir-lang/elixir/blob/d8f1a5d6b653c14ae44c6eacdbc8e9df7006d284/lib/elixir/pages/syntax-reference.md#the-elixir-ast>https://github.com/elixir-lang/elixir/blob/d8f1a5d6b653c14ae44c6eacdbc8e9df7006d284/lib/elixir/pages/syntax-reference.md#the-elixir-ast</a></p></article></main><footer id=footer><a href=https://github.com/hailelagi/blog>source</a>
Copyright © 2022 Haile Lagi</footer></body></html>